<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPS PRO v13 - Autonomie Totale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #0b101d; --card: #1c2333; --accent: #00d2ff; --success: #00ff88; --danger: #ff4bb4; --warning: #ffcc00; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; }
        .grid-6 { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 15px; }
        .card { background: var(--card); border-radius: 18px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 10px; }
        
        /* Chrono Individuel */
        .local-chrono { font-family: monospace; font-size: 2.5rem; text-align: center; font-weight: 800; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px; margin: 5px 0; }
        .state-run { color: var(--success); }
        .state-recup { color: var(--danger); }
        .state-idle { color: var(--accent); }

        /* Grille des résultats */
        .results-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .res-box { background: rgba(255,255,255,0.05); padding: 5px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .res-box small { font-size: 0.6rem; color: var(--accent); display: block; }
        .res-box b { font-size: 0.85rem; }

        /* Boutons */
        button { border: none; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .btn-action { height: 60px; font-size: 1.2rem; text-transform: uppercase; width: 100%; }
        .start { background: var(--success); color: #000; }
        .stop { background: var(--danger); color: #fff; }
        .wait { background: #333; color: #777; cursor: not-allowed; }
        
        .physio-input { background: #000; color: var(--warning); border: 1px solid #444; padding: 10px; border-radius: 8px; width: 100%; text-align: center; font-size: 1rem; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="screen1" class="active">
    <div class="card" style="max-width:500px; margin: 20px auto;">
        <h2 style="text-align:center">CONFIG SESSION</h2>
        <label>Cycle / Classe</label>
        <select id="cycle" onchange="updateClasse()"><option value="C3">Cycle 3</option><option value="C4">Cycle 4</option></select>
        <select id="classe" style="margin-top:10px"></select>
        
        <label>Atelier & Course</label>
        <select id="configAteliers" onchange="updateCourses()"><option value="C">Course Seule</option><option value="CS">Course + Saut</option><option value="CL">Course + Lancer</option></select>
        <select id="typeCourse" style="margin-top:10px" onchange="updateLaps()"></select>
        
        <label>Récupération (secondes)</label>
        <input type="number" id="tempsRecup" value="120">
        
        <input type="file" id="importExcel" style="margin-top:20px">
        <button onclick="launchSession()" style="background:var(--success); padding:15px; width:100%; margin-top:10px">OUVRIR LE TERRAIN</button>
    </div>
</div>

<div id="screen2" class="hidden">
    <div style="text-align:center; margin-bottom:15px;"><button onclick="location.reload()" style="background:var(--danger); color:white; padding:8px 15px;">RETOUR</button></div>
    <div id="grid" class="grid-6"></div>
</div>

<script>
let studentData = {};
let maxLaps = 3;
let allStudents = [];

// -- LOGIQUE CONFIGURATION (Identique à ton souhait) --
function updateClasse() {
    const c = document.getElementById('cycle').value;
    const cl = document.getElementById('classe');
    cl.innerHTML = c === 'C3' ? '<option value="6e">6ème</option>' : '<option value="5e">5e</option><option value="4e">4e</option><option value="3e">3e</option>';
    updateCourses();
}
function updateCourses() {
    const c = document.getElementById('cycle').value;
    const config = document.getElementById('configAteliers').value;
    const tc = document.getElementById('typeCourse');
    let opts = '<option value="3x400m">3x400m</option>';
    if(c === 'C4') {
        opts += '<option value="4x400m">4x400m</option><option value="Relais 2x40">Relais 2x40</option>';
        if(config === 'C') opts += '<option value="Laser Run">Laser Run</option><option value="Arcathlon">Arcathlon</option>';
    }
    tc.innerHTML = opts;
}
function updateLaps() {
    const tc = document.getElementById('typeCourse').value;
    maxLaps = (tc.includes('4x400') || tc.includes('Run') || tc.includes('Arca')) ? 4 : 3;
}

document.getElementById('importExcel').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, {type:'binary'});
        allStudents = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    };
    reader.readAsBinaryString(e.target.files[0]);
};

// -- LOGIQUE TERRAIN --
function launchSession() {
    document.getElementById('screen1').classList.add('hidden');
    document.getElementById('screen2').classList.remove('hidden');
    const container = document.getElementById('grid');
    const recupBase = parseInt(document.getElementById('tempsRecup').value);

    for(let i=0; i<6; i++) {
        studentData[i] = {
            state: 'IDLE', // IDLE, RUNNING, RECUP, FINISHED
            timer: 0,
            interval: null,
            laps: [],
            recupLeft: 0
        };

        container.innerHTML += `
            <div class="card" id="card-${i}">
                <select style="font-size:1.1rem">${allStudents.map(s => `<option>${s['Nom Prénom']}</option>`).join('')}</select>
                
                <div id="chrono-${i}" class="local-chrono state-idle">00:00.0</div>
                
                <div class="results-row">
                    ${Array.from({length: maxLaps}).map((_,l) => `<div class="res-box"><small>C${l+1}</small><b id="lap-${i}-${l}">--</b></div>`).join('')}
                </div>

                <button id="btn-${i}" class="btn-action start" onclick="toggleStudent(${i})">DÉPART</button>

                <div class="physio-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <input type="number" id="bpm-${i}" class="physio-input" placeholder="BPM">
                    <input type="number" id="rpe-${i}" class="physio-input" placeholder="RPE (1-10)">
                </div>
            </div>
        `;
    }
}

function toggleStudent(i) {
    let s = studentData[i];
    let btn = document.getElementById(`btn-${i}`);
    let display = document.getElementById(`chrono-${i}`);

    if(s.state === 'IDLE') {
        // Lancement Course
        s.state = 'RUNNING';
        s.timer = 0;
        display.className = "local-chrono state-run";
        btn.innerText = "ARRIVÉE";
        btn.className = "btn-action stop";
        
        s.interval = setInterval(() => {
            s.timer += 100;
            display.innerText = formatTime(s.timer);
        }, 100);

    } else if(s.state === 'RUNNING') {
        // Arrêt Course
        clearInterval(s.interval);
        s.laps.push(s.timer);
        document.getElementById(`lap-${i}-${s.laps.length-1}`).innerText = formatTime(s.timer);
        
        if(s.laps.length >= maxLaps) {
            s.state = 'FINISHED';
            btn.innerText = "TERMINÉ";
            btn.className = "btn-action wait";
            display.className = "local-chrono state-idle";
        } else {
            // Lancement Récup
            s.state = 'RECUP';
            s.recupLeft = parseInt(document.getElementById('tempsRecup').value);
            btn.className = "btn-action wait";
            display.className = "local-chrono state-recup";
            
            s.interval = setInterval(() => {
                s.recupLeft--;
                display.innerText = "RECUP: " + s.recupLeft + "s";
                btn.innerText = "ATTENDRE...";
                
                if(s.recupLeft <= 0) {
                    clearInterval(s.interval);
                    s.state = 'IDLE';
                    btn.innerText = "DÉPART C" + (s.laps.length + 1);
                    btn.className = "btn-action start";
                    display.className = "local-chrono state-idle";
                    display.innerText = "PRÊT !";
                }
            }, 1000);
        }
    }
}

function formatTime(ms) {
    let s = Math.floor(ms/1000);
    let m = Math.floor(s/60);
    let milli = Math.floor((ms%1000)/100);
    return `${m.toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}.${milli}`;
}

updateClasse();
</script>
</body>
</html>
